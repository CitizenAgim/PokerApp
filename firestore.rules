rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // HELPER FUNCTIONS
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    // Check if requester is a friend of the user
    function isFriend(userId) {
      return exists(/databases/$(database)/documents/users/$(userId)/friends/$(request.auth.uid));
    }
    
    // Check if item is shared
    function isShared() {
      return resource.data.isShared == true;
    }
    
    // ============================================
    // VALIDATION FUNCTIONS
    // ============================================
    
    // Validate player document structure and limits
    // Note: request.resource.data contains the full document after update
    function isValidPlayer(player) {
      return player.name != null 
        && player.name is string
        && player.name.size() >= 1
        && player.name.size() <= 100;
      // Size limits enforced by request.resource.size < 500000
    }
    
    // Validate session document structure and limits
    function isValidSession(session) {
      return session.name != null 
        && session.name is string
        && session.name.size() >= 1
        && session.name.size() <= 200;
      // Size limits enforced by request.resource.size < 1000000
    }

    // ============================================
    // USER DOCUMENT + SETTINGS
    // ============================================
    
    match /users/{userId} {
      allow read: if isAuthenticated();  // Basic profile visible to all authenticated
      allow write: if isOwner(userId);
      
      // ============================================
      // PLAYERS SUBCOLLECTION (with sharing)
      // ============================================
      
      match /players/{playerId} {
        // Owner: full read/write access
        // Note: Field validation done client-side in validation.ts
        // Note: Size limits temporarily disabled for debugging
        allow read, write: if isOwner(userId);
        
        // Friends: read if shared
        allow read: if isAuthenticated() && isFriend(userId) && isShared();
      }
      
      // ============================================
      // SESSIONS SUBCOLLECTION (with sharing)
      // ============================================
      
      match /sessions/{sessionId} {
        // Owner: full read/write access
        // Note: Field validation done client-side in validation.ts
        // Note: Size limits temporarily disabled for debugging
        allow read, write: if isOwner(userId);
        
        // Friends: read if shared
        allow read: if isAuthenticated() && isFriend(userId) && isShared();
        
        // Hands subcollection - inherit session access
        match /hands/{handId} {
          allow read, write: if isOwner(userId);
          // Friends can read hands if session is shared
          allow read: if isAuthenticated() && isFriend(userId) && 
            get(/databases/$(database)/documents/users/$(userId)/sessions/$(sessionId)).data.isShared == true;
        }
      }
      
      // ============================================
      // FRIENDS LIST
      // ============================================
      
      match /friends/{friendId} {
        allow read, write: if isOwner(userId);
        // Friend can read their own entry (to see permissions granted)
        allow read: if request.auth.uid == friendId;
      }
      
      // ============================================
      // IMPORTS (copied data from friends)
      // ============================================
      
      match /imports/{importId} {
        allow read, write: if isOwner(userId);
      }
    }

    // ============================================
    // FRIEND REQUESTS (global for discovery)
    // ============================================
    
    match /friendRequests/{requestId} {
      allow read: if isAuthenticated() && 
        (resource.data.fromUserId == request.auth.uid || 
         resource.data.toUserId == request.auth.uid);
      allow create: if isAuthenticated() && 
        request.resource.data.fromUserId == request.auth.uid;
      allow update: if isAuthenticated() && 
        resource.data.toUserId == request.auth.uid;
      allow delete: if isAuthenticated() && 
        (resource.data.fromUserId == request.auth.uid || 
         resource.data.toUserId == request.auth.uid);
    }

    // ============================================
    // LEGACY COLLECTIONS (Read-only for migration)
    // ============================================
    
    // Old flat players collection - allow read for migration, no new writes
    match /players/{playerId} {
      allow read: if isAuthenticated() && 
        resource.data.createdBy == request.auth.uid;
      allow write: if false;  // No new writes to legacy collection
    }
    
    // Old flat playerRanges collection - allow read for migration
    match /playerRanges/{rangeId} {
      allow read: if isAuthenticated();
      allow write: if false;  // No new writes to legacy collection
    }
    
    // Old flat sessions collection - allow read for migration, no new writes
    match /sessions/{sessionId} {
      allow read: if isAuthenticated() && 
        resource.data.createdBy == request.auth.uid;
      allow write: if false;  // No new writes to legacy collection
    }

    // Old flat hands collection
    match /hands/{handId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
      allow write: if false;  // No new writes to legacy collection
    }

    // ============================================
    // COLLECTION GROUP QUERIES
    // ============================================
    
    // Allow collection group query on 'hands' subcollection
    // This enables getUserHandsPaginated to query across all sessions
    match /{path=**}/hands/{handId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
  }
}
